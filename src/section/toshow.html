<div class="section-content">
    <div class="ui" style="margin-bottom: 0.5em;">
        <div class="ui right">
            <button class="ui primary button mini" onclick="toshowView()">Get</button>
        </div>
        <div class="ui right">
        </div>
    </div>
    <div id="toshow-view" class="filetree" style="height: 100%;"></div>
</div>

<script>
    
    function unitParse(parent,arr){
        !arr || arr.forEach((row,i)=>{
            parent.children.push({
                id: parent.group + "_" + (i+1),
                name: row.unit_name,
                degree : {longitude: row.geocd_lngt,latitude: row.geocd_ltd},
                sic: row.unit_sbl_cd,
                group: parent.group
            });
        });
    }
    function bmoaParse(parent,arr){
        !arr || arr.forEach((row,i)=>{
            parent.children.push({
                id: row.bmoa_id,
                name: row.bmoa_id,
                rad : row.bmoa_rads,
                degree : {longitude: row.geocd_lngt,latitude: row.geocd_ltd},
                sic: row.unit_sbl_cd,
                group: parent.group
            });
        });
    }
    function shipParse(parent,arr){
        !arr || arr.forEach((row,i)=>{
            parent.children.push({
                id: row.ship_id,
                name: row.ship_name,
                unit : row.unit_id,
                degree : {longitude: row.geocd_lngt,latitude: row.geocd_ltd},
                sic: row.unit_sbl_cd,
                group: parent.group
            });
        });
    }
    function aircraftParse(parent,arr){
        !arr || arr.forEach((row,i)=>{
            parent.children.push({
                id: row.air_id,
                name: row.air_name,
                unit : row.unit_id,
                degree : {longitude: row.geocd_lngt,latitude: row.geocd_ltd},
                sic: row.unit_sbl_cd,
                area: row.air_area_id,
                group: parent.group
            });
        });
    }
    var toShowNode = [{
                    name: '아군부대',
                    group:'ally',
                    collection:"KMilSymbol",
                    id: 'ALLY',
                    children: [],
                    parse:(parent,arr)=>{ unitParse(parent,arr); }
                }, {
                    name: '탄도미사일작전구역',
                    group:'bmoa',
                    collection:"Draw",
                    id: 'BMOA',
                    children: [],
                    parse:(parent,arr)=>{ bmoaParse(parent,arr); }
                }, {
                    name: '적부대',
                    group:'enemy',
                    collection:"KMilSymbol",
                    id: 'ENEMY',
                    children: [],
                    parse:(parent,arr)=>{ unitParse(parent,arr); }
                },{
                    name: '비행부대',
                    group:'aircraft',
                    collection:"KMilSymbol",
                    id: 'AIRCRAFT',
                    children: [],
                    parse:(parent,arr)=>{ aircraftParse(parent,arr); }
                },{
                    name: '함선',
                    group:'ship',
                    collection:"KMilSymbol",
                    id: 'SHIP',
                    children: [],
                    parse:(parent,arr)=>{ shipParse(parent,arr); }
                }, ];

    function toshowView() {
        serverAdapter.get('Entities', {}, function(data) {
            toShowNode.forEach((g)=>{
                if( !map.collection(g.group) ){map.createCollection(g.group, g.collection);}
                if( data[g.group] && g.parse ){
                    g.parse(g,data[g.group]);
                }
                console.dir(g);
            });  
            new OliveTree('#toshow-view', toShowNode, {
                onAttribute: function(d) {
                    return {
                            id: d.id,
                            name:d.name,
                            group : d.group
                    };
                },
                onText: function(d) {
                    return d.name;
                },
                onSelect:function(type, tag, obj) {
                        if (type == "file") {
                            var __this = obj;
                            let id = $(tag).data("id");
                            let group = $(tag).data('group');

                            map.oliveCamera.flyOverEntity(map.collection(group),id);

                            //  Math.tan(-(map.viewer3d.camera.pitch * Cesium.Math.DEGREES_PER_RADIAN) * (Math.PI / 180))//tangent 값
                            // map.oliveCamera.distance / Math.tan(-(map.viewer3d.camera.pitch * Cesium.Math.DEGREES_PER_RADIAN) * (Math.PI / 180))
                            //   위도거리는 어디서나 1도=111Km
                            
                        }else if( type == "folder"){

                        }
                },
                onChecked:function(checked,type,tag,obj){
                    let group = $(tag).data('group');
                        if (group === "bmoa") {
                            let addCollection = map.collection(group);
                            if( Cesium.defined(addCollection) ){
                                addCollection.removeAll();
                                var viewdata = toShowNode.find(function(d) {
                                    return (d.group === group) ? true : false;
                                });
                                if( viewdata && viewdata.children ){
                                    viewdata.children.forEach(row=>{
                                        app.drawObject("bmoa").type1(addCollection,row.degree,row.rad*1000,{
                                            faceColor: "#ffffff",faceTransparent: 0.5,
                                            lineColor: "#954045",
                                            text:row.name});
                                    });
                                }
                            }
                        } else {
                            let addCollection = map.collection(group);
                            if( Cesium.defined(addCollection) ){
                                addCollection.removeAll();
                                if (checked) {
                                    var viewdata = toShowNode.find(function(d) {
                                        return (d.group === group) ? true : false;
                                    });
                                    
                                    addCollection.terrianFromDegrees(viewdata.children,function(d){
                                        d.size = 30;
                                        let entity = addCollection.add(CTX.degree(d.degree.longitude,d.degree.latitude,d.degree.height), d);
                                        //console.dir(entity);
                                        let ele = $("#toshow-view [data-id="+d.id+"]");
                                        ele.data("id", entity.id);
                                    });
                                    /*
                                    viewdata.children.forEach(function(d) {
                                        d.size = 30;
                                        let entity = addCollection.add(CTX.degree(d.degree.longitude,d.degree.latitude,0), d);
                                        console.dir(entity);
                                        let ele = $("#toshow-view [data-id="+d.id+"]");
                                        ele.data("id", entity.id);
                                    });
                                    */
                                }   
                            }
                        }    
                        
                        
                }
            });    
        });
    }
</script>
<div class="section-content">
    <div class="ui" style="margin-bottom: 0.5em;">
        <div class="ui right">
            <button class="ui primary button mini" onclick="toshowView()">Get</button>
        </div>
        <div class="ui right">
        </div>
    </div>
    <div id="toshow-view" class="filetree" style="height: 100%;"></div>
</div>

<script>
    
    var toShowNode = [{
                    name: '아군부대',
                    group:'ALLY',
                    id: 'ALLY',
                    children: [],
                }, {
                    name: 'bmoa',
                    group:'BMOA',
                    id: 'BMOA',
                    children: [],
                }, {
                    name: '적부대',
                    group:'ENEMY',
                    id: 'ENEMY',
                    children: [],
                }, ];

    function toshowView() {
        serverAdapter.get('Entities', {}, function(resultdata) {
                
                var index = 0;
                let allyCollection = map.collection('ALLY');
                let enemyCollection = map.collection('ENEMY');
                var options = {};
                for (var r in resultdata) {
                    toShowNode[index].children = resultdata[r].reduce(function(prev, curr, i) {
                        if (curr.hasOwnProperty('unit_name')) {
                            prev.push({
                                id: toShowNode[index].group + "_" + (i+1),
                                name: curr.unit_name,
                                cartesianVal: Cesium.Cartesian3.fromDegrees(
                                    parseFloat(curr.geocd_lngt),
                                    parseFloat(curr.geocd_ltd),
                                    0
                                ),
                                x: curr.geocd_lngt,
                                y: curr.geocd_ltd,
                                sic: curr.unit_sbl_cd,
                                group: toShowNode[index].group
                            });
                        } else {
                            prev.push({
                                name: curr.bmoa_id,
                                cartesianVal: Cesium.Cartesian3.fromDegrees(
                                    parseFloat(curr.geocd_lngt),
                                    parseFloat(curr.geocd_ltd),
                                    0
                                ),
                                rad : curr.bmoa_rads,
                                x: curr.geocd_lngt,
                                y: curr.geocd_ltd,
                                sic: curr.unit_sbl_cd,
                                group: toShowNode[index].group
                            });
                        }
                        return prev;
                    }, []);
                    index++;
                }
                new OliveTree('#toshow-view', toShowNode, {
                    onAttribute: function(d) {
                        return {
                            id: d.id,
                            name:d.name,
                            group : d.group
                        };
                    },
                    onText: function(d) {
                        return d.name;
                    },
                    onSelect:function(type, tag, obj) {
                        if (type == "file") {
                            var __this = obj;
                            let id = $(tag).data("id");
                            let group = $(tag).data('group');

                            map.oliveCamera.flyOverEntity(group,id);

                            //  Math.tan(-(map.viewer3d.camera.pitch * Cesium.Math.DEGREES_PER_RADIAN) * (Math.PI / 180))//tangent 값
                            // map.oliveCamera.distance / Math.tan(-(map.viewer3d.camera.pitch * Cesium.Math.DEGREES_PER_RADIAN) * (Math.PI / 180))
                            //   위도거리는 어디서나 1도=111Km
                            
                        }else if( type == "folder"){

                        }
                        
                    },
                    onChecked:function(checked,type,tag,obj){
                        
                        let group = $(tag).data('group');
                        if (group === "BMOA") {
                            console.log("지도에 뿌릴 데이터가 정의되면 처리하도록 하겠습니다.");
                        } else {
                            let addCollection = map.collection(group);
                            if( Cesium.defined(addCollection) ){
                                addCollection.removeAll();
                                if (checked) {
                                    var viewdata = toShowNode.find(function(d) {
                                        return (d.id === group) ? true : false;
                                    });
                                    viewdata.children.forEach(function(d) {
                                        d.size = 30;
                                        let entity = addCollection.add(d.cartesianVal, d);
                                        console.dir(entity);
                                        let ele = $("#toshow-view [data-id="+d.id+"]");
                                        ele.data("id", entity.id);
                                    });
                                }   
                            }
                        }
                        
                    }
                });
            });
    }
</script>